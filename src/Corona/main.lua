--
--  main.lua
--  Kochava Sample App
--
--  Copyright (c) 2016 Corona Labs Inc. All rights reserved.
--

local kochava = require( "plugin.kochava" )
local widget = require( "widget" )
local json = require("json")

-----------------------
-- Setup
-----------------------
display.setStatusBar( display.HiddenStatusBar )
display.setDefault( "background", 1 )

local logString = ""

local processEventTable = function(event)
  local logString = json.prettify(event):gsub("\\","")
  logString = "\nPHASE: "..event.phase.." - - - - - - - - - - - -\n" .. logString
  print(logString)
  eventDataTextBox.text = logString .. eventDataTextBox.text
end

-- set app id and store data
local appGUID
local storeName
local receiptData
local receiptSignature

if (system.getInfo( "platformName" ) == "Android") then
  appGUID = "kocorona-plugin-sample-android570b199f380e5"
  storeName = "Google"
  receiptData = [[{"orderId":"12999763169054705758.1370659711695372","packageName":"com.swipeware.freemium.bigfatgoalie","productId":"com.swipeware.freemium.bigfatgoalie.lifetimepass","purchaseTime":1375685100000,"purchaseState":0,"purchaseToken":"tqhfxyywyhzwnbgitqyskmmv.AO-J1OxU2eO3XVD_KUkvEK3NW8Wh1WcP9N6OcjTNIVoJ14sk8hSo1UOl5BmWhls6WwA6_fVTaVVy2QowWFugtmRnd-7wTr46wBA-XGFx2oB8Rd0lFDtiRBPfdT6B4srHpldf4IsONvW-KjZP8eLuamp7Cr9hhRc6CqnNT6ol-pRH16vSxmW3aBRkJZbrSWC9YX9y_SppNgbJ"}]]
  receiptSignature = "iS8qp3hIJ8d3wJQWiWu3WbKpTzBRQhbdz7EV+mNLgjTB1OjqTqW5J30cXX71UQiYRTCc699Ffd+tbvLxwot8I9+n0W1j/d8piu+ekW0jRSQPiDHnkdWOJoTbkoneuBhT6bt0ev4uW4F4Fh/UoKKJtkJd+pzPWT2V1pFTKvbmyj3HkTI8cFo35Iw9lE2pUjXO6ZLJGvPcHoqCLeV+F3rd6K0C3uoKP2cSK8xreEGURqhIYZkQU88FMWsIsKZBQ32sVMNW6Vx3dW10DeyXDUEvEdk04bcKi1lEnfht7p4quIJKZ7zNF3jE/529WJC6P4QcPLqO+qLl03ZGNpCEIMUXQA=="
else -- iOS
  appGUID = "kocorona-plugin-sample-ios570b196ee5db8"
  storeName = "Apple"
  receiptData = "<7b0a0922 7369676e 61747572 6522203d 20224179 4e513436 477a7141 454c5732 524e3032 714d3052 6a377332 62642b33 6a6f4261 32794632 4331682f 59377036 34625677 6b654c32 64723931 4a386d4b 48547a47 62333030 54576346 59485248 57634776 51376942 6a67774c 386a5537 4e782f64 66356c72 64544941 5536466d 4f71344e 48483879 67333568 50564451 4a642f4d 5876574b 355a6b74 33633046 56666d44 64416248 56576975 4575647a 61374434 494e3941 67346871 44732f56 576c7151 75305743 47682b61 4d433758 6a4d4653 624c6f61 4f484a74 2f2f746b 4c554143 4b394648 4f705750 67637869 71646949 76657748 4e437a36 546b4379 46727261 4f53536a 52712f78 6c617a59 37716770 424f5951 68797143 7a525049 746c7264 6b796266 6864514d 6f2f624f 43397651 4e4f4956 4f336a70 6c394f30 366e576f 76783832 4f2f7731 6b69686a 446d514b 4e622f47 644b5858 57614e70 4e703267 487a557a 73414141 57414d49 49466644 43434247 53674177 49424167 49494475 7458682b 65654359 30774451 594a4b6f 5a496876 634e4151 45464251 4177675a 5978437a 414a4267 4e564241 5954416c 56544d52 4d774551 59445651 514b4441 70426348 42735a53 424a626d 4d754d53 77774b67 59445651 514c4443 4e426348 42735a53 42586233 4a735a48 64705a47 55675247 56325a57 78766347 56794946 4a6c6247 46306157 3975637a 46454d45 49474131 55454177 77375158 42776247 55675632 39796247 52336157 526c4945 526c646d 56736233 426c6369 42535a57 78686447 6c76626e 4d675132 56796447 6c6d6157 4e686447 6c766269 42426458 526f6233 4a706448 6b774868 634e4d54 55784d54 457a4d44 49784e54 41355768 634e4d6a 4d774d6a 41334d6a 45304f44 5133576a 43426954 45334d44 55474131 55454177 77755457 466a4945 46776343 42546447 39795a53 4268626d 51676156 5231626d 567a4946 4e306233 4a6c4946 4a6c5932 56706348 51675532 6c6e626d 6c755a7a 45734d43 6f474131 55454377 776a5158 42776247 55675632 39796247 52336157 526c4945 526c646d 56736233 426c6369 42535a57 78686447 6c76626e 4d78457a 41524267 4e564241 6f4d436b 46776347 786c4945 6c755979 3478437a 414a4267 4e564241 5954416c 56544d49 4942496a 414e4267 6b71686b 69473977 30424151 45464141 4f434151 38414d49 49424367 4b434151 45417063 2b422f53 57696756 7657682b 306a326a 4d636a75 496a774b 58454a73 73397870 2f735367 31566876 2b6b4174 6558796a 6c556258 312f736c 51596e63 5173556e 474f5a48 75437a6f 6d365364 59493562 53496363 382f5730 59757873 51647541 4f70574b 49455069 46343164 75333049 34536a59 4e4d5779 706f4e35 50433872 3065784e 4b684445 70595571 7353342b 33644835 67566b44 55747773 7753796f 31496766 64596546 52723649 77784e68 394b4267 78485650 4d336b4c 69796b6f 6c395836 53465375 48416e4f 4336704c 75436c32 50304b35 50422f54 35767973 4831504b 6d505568 72414a51 70324474 372b6d66 372f776d 76315731 36736331 464a4346 614a7a45 4f517a49 36424174 43676c37 5a637361 46706159 65514547 676d4a6a 6d344852 427a7341 70647858 50513333 59373243 335a6942 376a3741 6650346f 3751302f 6f6d5659 48763467 4e4a4977 49444151 41426f34 4942317a 43434164 4d775077 59494b77 59424251 55484151 45454d7a 41784d43 38474343 73474151 5546427a 41426869 4e6f6448 52774f69 38766232 4e7a6343 35686348 42735a53 356a6232 30766232 4e7a6344 417a4c58 64335a48 49774e44 41644267 4e564851 34454667 51556b61 53632f4d 52327435 2b676976 524e3959 38325865 30724249 55774441 59445652 30544151 482f4241 49774144 41664267 4e564853 4d454744 41576742 53494a78 634a7162 59595949 76733637 72325231 6e46556c 536a747a 43434152 34474131 55644941 53434152 55776767 45524d49 49424451 594b4b6f 5a496876 646a5a41 55474154 43422f6a 43427777 59494b77 59424251 55484167 49776762 594d6762 4e535a57 78705957 356a5a53 42766269 42306147 6c7a4947 4e6c636e 52705a6d 6c6a5958 526c4947 4a354947 46756553 42775958 4a306553 42686333 4e316257 567a4947 466a5932 56776447 46755932 55676232 59676447 686c4948 526f5a57 34675958 42776247 6c6a5957 4a735a53 427a6447 46755a47 46795a43 42305a58 4a746379 4268626d 51675932 39755a47 6c306157 39756379 42765a69 42316332 55734947 4e6c636e 52705a6d 6c6a5958 526c4948 42766247 6c6a6553 4268626d 51675932 56796447 6c6d6157 4e686447 6c766269 4277636d 466a6447 6c6a5a53 427a6447 46305a57 316c626e 527a4c6a 41324267 67724267 45464251 63434152 59716148 52306344 6f764c33 64336479 35686348 42735a53 356a6232 30765932 56796447 6c6d6157 4e686447 56686458 526f6233 4a706448 6b764d41 34474131 55644477 45422f77 51454177 49486744 41514267 6f71686b 69473932 4e6b4267 73424241 49464144 414e4267 6b71686b 69473977 30424151 55464141 4f434151 45414461 59623079 34393431 73724232 35436c6d 7a543649 78444d49 4a663446 7a526a62 36394437 30612f43 57533234 79467734 425a332b 50693179 3446464b 774e3237 61342f76 77314c6e 7a4c7252 64726a6e 38663548 65357357 65567442 4e657068 6d476476 6861494a 586e5934 7750632f 7a6f3763 59667270 6e345a55 68636f4f 416f4f73 41514e79 32356f41 51354833 4f357941 58393874 352f4769 6f716269 73422f4b 4167584e 6e726653 656d4d2f 6a316d4f 432b524e 75785447 66386267 70507965 4947714e 4b583836 654f6131 4769576f 52315a64 45574247 4c6a7756 2f31434b 6e50614e 6d53414d 6e426a4c 50346a51 426b756c 68677748 79766a33 584b6162 6c624b74 59646147 36595176 564d707a 635a6d38 77374848 6f5a512f 4f6a6262 39495941 594d4e70 4972374e 34597452 48614c53 50516a76 7967615a 77584735 3641657a 6c485254 42684c38 63547141 3d3d223b 0a092270 75726368 6173652d 696e666f 22203d20 2265776f 4a496d39 79615764 70626d46 734c5842 31636d4e 6f59584e 6c4c5752 68644755 7463484e 30496941 39494349 794d4445 7a4c5441 334c5445 32494441 314f6a55 7a4f6a51 33494546 745a584a 70593245 76544739 7a583046 755a3256 735a584d 694f776f 4a496e56 75615846 315a5331 705a4756 7564476c 6d615756 79496941 39494349 354d6a6b 794e7a46 6a597a42 684e5456 6c4f574a 6b593252 684e7a68 6d4e5467 31596a67 334f5449 32596a67 774f4752 694d6d49 78496a73 4b43534a 76636d6c 6e615735 68624331 30636d46 75633246 6a64476c 76626931 705a4349 67505341 694d5441 774d4441 774d4441 344d4455 344e7a67 7a4e6949 3743676b 69596e5a 79637949 67505341 694d5334 32496a73 4b43534a 30636d46 75633246 6a64476c 76626931 705a4349 67505341 694d5441 774d4441 774d4445 784f4451 7a4f444d 354e7949 3743676b 69635856 68626e52 7064486b 69494430 67496a45 694f776f 4a496d39 79615764 70626d46 734c5842 31636d4e 6f59584e 6c4c5752 68644755 7462584d 69494430 67496a45 7a4e7a4d 354e7a6b 794d6a63 774d4441 694f776f 4a496e56 75615846 315a5331 325a5735 6b623349 74615752 6c626e52 705a6d6c 6c636949 67505341 69515463 314f5456 434e5545 744f554a 46524330 30524549 304c546b 314d5451 74526a55 344d6a56 424e6a41 344d3046 46496a73 4b43534a 77636d39 6b64574e 304c576c 6b496941 3949434a 6a623230 75633364 70634756 3359584a 6c4c6d5a 795a5756 74615856 744c6d4a 705a325a 68644764 76595778 705a5335 7361575a 6c64476c 745a5642 6863334d 694f776f 4a496d6c 305a5730 74615751 69494430 67496a51 334f5445 304d5445 324d6949 3743676b 69596d6c 6b496941 3949434a 6a623230 75633364 70634756 3359584a 6c4c6d5a 795a5756 74615856 744c6d4a 705a325a 68644764 76595778 705a5349 3743676b 69634856 79593268 68633255 745a4746 305a5331 74637949 67505341 694d5451 774e6a59 304e5459 784d5441 774d4349 3743676b 69634856 79593268 68633255 745a4746 305a5349 67505341 694d6a41 784e4330 774e7930 794f5341 784e446f 314d7a6f 7a4d5342 4664474d 76523031 55496a73 4b43534a 7764584a 6a614746 7a5a5331 6b595852 6c4c5842 7a644349 67505341 694d6a41 784e4330 774e7930 794f5341 774e7a6f 314d7a6f 7a4d5342 42625756 7961574e 684c3078 76633139 42626d64 6c624756 7a496a73 4b43534a 76636d6c 6e615735 68624331 7764584a 6a614746 7a5a5331 6b595852 6c496941 39494349 794d4445 7a4c5441 334c5445 32494445 794f6a55 7a4f6a51 33494556 30597939 48545651 694f7770 39223b0a 0922656e 7669726f 6e6d656e 7422203d 20225361 6e64626f 78223b0a 0922706f 6422203d 20223130 30223b0a 09227369 676e696e 672d7374 61747573 22203d20 2230223b 0a7d>"
  receiptSignature = nil
end

print( "Using " .. appGUID )

local kochavaListener = function(event)
  processEventTable(event)
end

kochava.init(kochavaListener, {
  appGUID = appGUID,
  enableDebugLogging = true,
  enableAttributionData = true,
  --limitAdTracking = true
})

-----------------------
-- UI
-----------------------
local kochavaLogo = display.newImage( "kochava-logo.png" )
kochavaLogo.anchorY = 0
kochavaLogo.x, kochavaLogo.y = display.contentCenterX, 0
kochavaLogo:scale( 0.8, 0.8 )

local subTitle = display.newText {
  text = "plugin for Corona SDK",
  x = display.contentCenterX,
  y = 75,
  font = display.systemFont,
  fontSize = 20
}
subTitle:setTextColor( 0.2, 0.2, 0.2 )

eventDataTextBox = native.newTextBox( display.contentCenterX, display.contentHeight - 50, 310, 150)
eventDataTextBox.placeholder = "Event data will appear here"

local logCustomEventButton = widget.newButton {
  label = "Log Custom Event",
  onRelease = function(event)
    kochava.logEvent("playerDied", {
      level="1",
      score="23451",
      mode="expert",
      boss="hugo",
      weaponEmpty=true,
      durationTimeInterval=652,
      timeDelta=146
    })
  end
}
logCustomEventButton.x = display.contentCenterX;
logCustomEventButton.y = 120;

local idLinkButton = widget.newButton {
  label = "Set ID Link",
  onRelease = function(event)
    kochava.setIdentityLink({mySpecialID="1234567890"})
  end
}
idLinkButton.x = display.contentCenterX;
idLinkButton.y = logCustomEventButton.y + idLinkButton.contentHeight;

local receiptButton = widget.newButton {
  label = "Log " .. storeName .. " Receipt",
  onRelease = function(event)
    kochava.logEvent("purchase", {
      name = "Bonus Pack",
      receiptData = receiptData,
      receiptDataSignature = receiptSignature
    })
  end
}
receiptButton.x = display.contentCenterX;
receiptButton.y = idLinkButton.y + receiptButton.contentHeight;

local deepLinkButton = widget.newButton {
  label = "Log Deep link",
  onRelease = function(event)
    kochava.logDeeplinkEvent("testapp://news/123", "com.sample.openme")
  end
}
deepLinkButton.x = display.contentCenterX;
deepLinkButton.y = receiptButton.y + deepLinkButton.contentHeight;

local attributionButton = widget.newButton {
  label = "Get Attribution",
  onRelease = function(event)
    kochava.getAttributionData()
  end
}
attributionButton.x = display.contentCenterX;
attributionButton.y = deepLinkButton.y + attributionButton.contentHeight;
